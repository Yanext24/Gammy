<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="article">
    <meta property="og:image" content="">
    <title>Пост - Gammy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css?v=15">
</head>
<body>
    <!-- Header -->
    <header class="header glass">
        <div class="container header-content">
            <a href="../index.html" class="logo">
                <span class="logo-icon">G</span>
                <span class="logo-text">Gammy</span>
            </a>
            <nav class="nav">
                <a href="../index.html" class="nav-link">Лента</a>
                <a href="../blog.html" class="nav-link">Блог</a>
                <a href="categories.html" class="nav-link">Категории</a>
                <a href="about.html" class="nav-link">О нас</a>
            </nav>
            <div class="header-actions">
                <div class="notifications-wrapper hidden" id="notificationsWrapper">
                    <button class="notifications-btn" id="notificationsBtn" aria-label="Уведомления">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notifications-badge hidden" id="notificationsBadge">0</span>
                    </button>
                    <div class="notifications-dropdown glass hidden" id="notificationsDropdown">
                        <div class="notifications-header">
                            <h3>Уведомления</h3>
                            <button onclick="Notifications.markAllAsRead()">Прочитать все</button>
                        </div>
                        <div class="notifications-list" id="notificationsList"></div>
                    </div>
                </div>
                <button class="theme-toggle" id="themeToggle" aria-label="Переключить тему">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <div class="auth-buttons" id="authButtons">
                    <button class="btn btn-ghost" id="loginBtn">Войти</button>
                    <button class="btn btn-primary" id="registerBtn">Регистрация</button>
                </div>
                <div class="user-menu hidden" id="userMenu">
                    <button class="user-avatar" id="userAvatarBtn"><span id="userInitial">U</span></button>
                    <div class="user-dropdown glass" id="userDropdown">
                        <div class="user-info">
                            <span class="user-name" id="userName">Пользователь</span>
                            <span class="user-email" id="userEmail">user@email.com</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="profile.html" class="dropdown-item">Профиль</a>
                        <a href="admin.html" class="dropdown-item admin-only hidden" id="adminLink">Админ-панель</a>
                        <button class="dropdown-item" id="logoutBtn">Выйти</button>
                    </div>
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Меню">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </header>

    <div class="mobile-menu glass" id="mobileMenu">
        <nav class="mobile-nav">
            <a href="../index.html" class="mobile-nav-link">Лента</a>
            <a href="../blog.html" class="mobile-nav-link">Блог</a>
            <a href="categories.html" class="mobile-nav-link">Категории</a>
            <a href="about.html" class="mobile-nav-link">О нас</a>
        </nav>
        <div class="mobile-auth" id="mobileAuth">
            <button class="btn btn-ghost btn-full" id="mobileLoginBtn" onclick="Modals.showLoginModal(); document.getElementById('mobileMenu').classList.remove('active');">Войти</button>
            <button class="btn btn-primary btn-full" id="mobileRegisterBtn" onclick="Modals.showRegisterModal(); document.getElementById('mobileMenu').classList.remove('active');">Регистрация</button>
        </div>
        <div class="mobile-user hidden" id="mobileUser">
            <a href="profile.html" class="btn btn-ghost btn-full">Профиль</a>
            <a href="admin.html" class="btn btn-ghost btn-full mobile-admin-only hidden" id="mobileAdminLink">Админ-панель</a>
            <button class="btn btn-outline btn-full" id="mobileLogoutBtn" onclick="Auth.logout(); document.getElementById('mobileMenu').classList.remove('active');">Выйти</button>
        </div>
    </div>

    <!-- Post Page -->
    <main class="post-page">
        <div class="container">
            <div class="post-page-layout">
                <article class="post-full" id="postFull">
                    <!-- Post will be loaded here -->
                    <div class="loading-post">
                        <p>Загрузка поста...</p>
                    </div>
                </article>

                <!-- Comments Section -->
                <section class="post-comments-section" id="postCommentsSection" style="display: none;">
                    <h3 class="comments-section-title">
                        Комментарии <span id="postCommentsCount">0</span>
                    </h3>

                    <!-- Comment Form -->
                    <div class="post-comment-form" id="postCommentForm">
                        <div class="post-comment-form-avatar" id="commentFormAvatar">?</div>
                        <div class="post-comment-form-input">
                            <textarea id="postCommentText" placeholder="Напишите комментарий..." rows="2"></textarea>
                            <button class="btn btn-primary btn-sm" id="submitPostComment">Отправить</button>
                        </div>
                    </div>

                    <!-- Comments List -->
                    <div class="post-comments-list" id="postCommentsList">
                        <!-- Comments will be loaded here -->
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <a href="../index.html" class="logo">
                        <span class="logo-icon">G</span>
                        <span class="logo-text">Gammy</span>
                    </a>
                    <p class="footer-desc">Современный блог о технологиях, дизайне и инновациях.</p>
                </div>
                <div class="footer-section">
                    <h4 class="footer-title">Навигация</h4>
                    <nav class="footer-nav">
                        <a href="../index.html">Лента</a>
                        <a href="../blog.html">Блог</a>
                        <a href="categories.html">Категории</a>
                        <a href="about.html">О нас</a>
                    </nav>
                </div>
                <div class="footer-section">
                    <h4 class="footer-title">Категории</h4>
                    <nav class="footer-nav footer-categories-nav">
                        <!-- Loaded dynamically from API -->
                    </nav>
                </div>
                <div class="footer-section">
                    <h4 class="footer-title">Подписка</h4>
                    <p class="footer-text">Получайте новые статьи на почту</p>
                    <form class="subscribe-form" id="subscribeForm">
                        <input type="email" placeholder="Ваш email" required>
                        <button type="submit" class="btn btn-primary">OK</button>
                    </form>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Gammy Blog. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-message" id="toastMessage"></span>
    </div>

    <script src="../js/api.js?v=11"></script>
    <script src="../js/app.js?v=20"></script>
    <script src="../js/feed.js?v=7"></script>
    <script>
        let currentPost = null;

        // Wait for Auth to be initialized
        async function waitForAuth() {
            let attempts = 0;
            while (!window.Auth?._initialized && attempts < 100) {
                await new Promise(r => setTimeout(r, 50));
                attempts++;
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for Auth initialization from app.js
            await waitForAuth();

            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            const postSlug = urlParams.get('slug');

            if (!postId && !postSlug) {
                window.location.href = '../index.html';
                return;
            }

            try {
                // Load by slug if available, otherwise by id
                if (postSlug) {
                    currentPost = await API.getPostBySlug(postSlug);
                } else {
                    currentPost = await API.getPost(postId);
                }
                renderPost(currentPost);
            } catch (err) {
                document.getElementById('postFull').innerHTML = `
                    <div class="post-not-found" style="text-align: center; padding: 60px 20px;">
                        <h2>Пост не найден</h2>
                        <p style="color: var(--text-muted); margin: 16px 0;">Возможно, он был удалён или ссылка неверна</p>
                        <a href="../index.html" class="btn btn-primary">Вернуться к ленте</a>
                    </div>
                `;
                return;
            }
        });

        function renderPost(post) {
            // Update meta tags
            document.title = `${post.content.substring(0, 50)}... - Gammy`;

            const authorName = post.author_name || 'Аноним';
            const avatarHtml = post.author_avatar
                ? `<img src="${post.author_avatar}" alt="${authorName}">`
                : authorName.charAt(0).toUpperCase();

            // Format content with links
            const formattedContent = formatContent(post.content);

            // Get images and tags (API returns arrays)
            let images = Array.isArray(post.images) ? post.images : [];
            let tags = Array.isArray(post.tags) ? post.tags : [];

            // Render post
            document.getElementById('postFull').innerHTML = `
                <div class="post-full-header">
                    <div class="post-author-avatar post-full-avatar">${avatarHtml}</div>
                    <div class="post-author-info">
                        <span class="post-author-name">${authorName}</span>
                        <div class="post-meta">${UI.timeAgo(post.created_at)} • ${post.views || 0} просмотров</div>
                    </div>
                </div>
                <div class="post-full-content">
                    <div class="post-text">${formattedContent}</div>
                    ${images.length > 0 ? renderImageGallery(images, post.id) : ''}
                    ${tags.length > 0 ? `
                        <div class="post-tags" style="margin-top: 20px;">
                            ${tags.map(tag => `
                                <a href="../index.html?tag=${tag.toLowerCase()}" class="post-tag">#${tag}</a>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="post-full-actions">
                    <button class="post-action-btn" onclick="togglePostLike(${post.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span id="postLikeCount">${post.likes_count || 0}</span>
                    </button>
                    <button class="post-action-btn" onclick="shareCurrentPost()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                        Поделиться
                    </button>
                </div>
            `;

            // Show comments section
            document.getElementById('postCommentsSection').style.display = 'block';
            loadPostComments(post.id);

            // Comment form avatar
            updateCommentFormAvatar();

            // Submit comment
            document.getElementById('submitPostComment').addEventListener('click', () => {
                submitPostComment(post.id);
            });
        }

        function formatContent(content) {
            if (!content) return '';
            return content
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>')
                .replace(/\n/g, '<br>');
        }

        // Telegram-style image gallery
        function getImagesClass(count) {
            if (count === 1) return 'single';
            if (count === 2) return 'double';
            if (count === 3) return 'triple';
            if (count === 4) return 'quad';
            return 'many';
        }

        function renderImageGallery(images, postId) {
            const count = images.length;
            const galleryClass = getImagesClass(count);
            const displayImages = images.slice(0, 4);
            const extraCount = count - 4;

            let html = `<div class="post-images ${galleryClass}" style="margin-top: 20px;" data-post-id="${postId}" data-images='${JSON.stringify(images)}'>`;

            displayImages.forEach((img, index) => {
                const isLast = index === 3 && extraCount > 0;
                if (isLast) {
                    html += `
                        <div class="post-image-wrapper has-more" data-more="+${extraCount}" onclick="openGallery(${postId}, ${index})">
                            <img src="${img}" alt="" class="post-image" loading="lazy">
                        </div>`;
                } else {
                    html += `<img src="${img}" alt="" class="post-image" onclick="openGallery(${postId}, ${index})" loading="lazy">`;
                }
            });

            html += '</div>';
            return html;
        }

        function openGallery(postId, startIndex = 0) {
            const gallery = document.querySelector(`.post-images[data-post-id="${postId}"]`);
            if (!gallery) return;

            const images = JSON.parse(gallery.dataset.images || '[]');
            if (images.length === 0) return;

            showLightbox(images, startIndex);
        }

        let lightboxImages = [];
        let lightboxCurrent = 0;

        function showLightbox(images, currentIndex = 0) {
            lightboxImages = images;
            lightboxCurrent = currentIndex;

            const existing = document.getElementById('imageLightbox');
            if (existing) existing.remove();

            const lightbox = document.createElement('div');
            lightbox.id = 'imageLightbox';
            lightbox.className = 'lightbox-overlay';
            lightbox.innerHTML = `
                <div class="lightbox-content">
                    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
                    ${images.length > 1 ? `
                        <button class="lightbox-nav lightbox-prev" onclick="lightboxPrev()">&#10094;</button>
                        <button class="lightbox-nav lightbox-next" onclick="lightboxNext()">&#10095;</button>
                    ` : ''}
                    <img src="${images[currentIndex]}" alt="" class="lightbox-image" id="lightboxImage">
                    ${images.length > 1 ? `
                        <div class="lightbox-counter">
                            <span id="lightboxCurrent">${currentIndex + 1}</span> / ${images.length}
                        </div>
                    ` : ''}
                </div>
            `;

            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) closeLightbox();
            });

            document.addEventListener('keydown', lightboxKeyHandler);

            document.body.appendChild(lightbox);
            document.body.style.overflow = 'hidden';

            requestAnimationFrame(() => lightbox.classList.add('active'));
        }

        function lightboxKeyHandler(e) {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') lightboxPrev();
            if (e.key === 'ArrowRight') lightboxNext();
        }

        function closeLightbox() {
            const lightbox = document.getElementById('imageLightbox');
            if (lightbox) {
                lightbox.classList.remove('active');
                setTimeout(() => lightbox.remove(), 300);
                document.body.style.overflow = '';
                document.removeEventListener('keydown', lightboxKeyHandler);
            }
        }

        function lightboxPrev() {
            lightboxCurrent = (lightboxCurrent - 1 + lightboxImages.length) % lightboxImages.length;
            document.getElementById('lightboxImage').src = lightboxImages[lightboxCurrent];
            const counter = document.getElementById('lightboxCurrent');
            if (counter) counter.textContent = lightboxCurrent + 1;
        }

        function lightboxNext() {
            lightboxCurrent = (lightboxCurrent + 1) % lightboxImages.length;
            document.getElementById('lightboxImage').src = lightboxImages[lightboxCurrent];
            const counter = document.getElementById('lightboxCurrent');
            if (counter) counter.textContent = lightboxCurrent + 1;
        }

        async function togglePostLike(postId) {
            try {
                const result = await API.likePost(postId);
                document.getElementById('postLikeCount').textContent = result.likes_count;

                // Update button state
                const likeBtn = document.querySelector('.post-full-actions .post-action-btn');
                const svg = likeBtn?.querySelector('svg');
                if (result.liked) {
                    likeBtn?.classList.add('liked');
                    svg?.setAttribute('fill', 'currentColor');
                } else {
                    likeBtn?.classList.remove('liked');
                    svg?.setAttribute('fill', 'none');
                }
            } catch (err) {
                UI.showToast(err.message || 'Войдите, чтобы лайкать', 'error');
            }
        }

        function shareCurrentPost() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({ title: document.title, url });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    UI.showToast('Ссылка скопирована!');
                });
            }
        }

        function updateCommentFormAvatar() {
            const avatar = document.getElementById('commentFormAvatar');
            const user = Auth.getCurrentUser();
            if (user) {
                if (user.avatar) {
                    avatar.innerHTML = `<img src="${user.avatar}" alt="${user.name}">`;
                } else {
                    avatar.textContent = user.name.charAt(0).toUpperCase();
                }
            }
        }

        async function loadPostComments(postId) {
            const container = document.getElementById('postCommentsList');
            const countEl = document.getElementById('postCommentsCount');

            try {
                const comments = await API.getPostComments(postId);
                countEl.textContent = comments.length;

                if (comments.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Пока нет комментариев</p>';
                    return;
                }

                container.innerHTML = comments.map(comment => {
                    const avatarHtml = comment.user_avatar
                        ? `<img src="${comment.user_avatar}" alt="${comment.author_name}">`
                        : (comment.author_name || 'А').charAt(0).toUpperCase();

                    return `
                        <div class="post-comment">
                            <div class="post-comment-avatar">${avatarHtml}</div>
                            <div class="post-comment-body">
                                <div class="post-comment-header">
                                    <span class="post-comment-author">${comment.author_name}</span>
                                    <span class="post-comment-date">${UI.timeAgo(comment.created_at)}</span>
                                </div>
                                <div class="post-comment-text">${comment.content}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Ошибка загрузки комментариев</p>';
            }
        }

        async function submitPostComment(postId) {
            const text = document.getElementById('postCommentText').value.trim();
            const user = Auth.getCurrentUser();

            if (!text) {
                UI.showToast('Напишите комментарий', 'error');
                return;
            }

            if (!user) {
                UI.showToast('Войдите, чтобы комментировать', 'error');
                Modals.showLoginModal();
                return;
            }

            try {
                await API.addPostComment(postId, { content: text });
                document.getElementById('postCommentText').value = '';
                UI.showToast('Комментарий добавлен!');
                loadPostComments(postId);
            } catch (err) {
                UI.showToast(err.message || 'Ошибка', 'error');
            }
        }
    </script>
</body>
</html>
